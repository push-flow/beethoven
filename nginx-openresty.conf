worker_processes 1;
daemon off;
events {
        worker_connections 1024;
}
http {

        server {

                listen 80;
                charset utf-8;
                location /bots {

                        set $proxy_addr '';
                        access_by_lua_block {

                                local redis = require "resty.redis"
                                local red = redis:new()

                                red:set_timeout(1000)


                                local ok, err = red:connect("127.0.0.1", 6379)
                                if not ok then
                                        ngx.say("failed to connect: ", err)
                                        return
                                end

                                ngx.var.proxy_addr = red:get(ngx.var.arg_uuid)
                        }
                        proxy_pass http://$proxy_addr;
                }

        }
}
